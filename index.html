<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>üíï Surprise ‚Äî One Page (Love Gate, No-Music)</title>
  <style>
    :root{
      --pink:#ff7aa2; --rose:#ff9fb8; --mint:#a5f3e6; --lav:#c7d2fe; --text:#3d2b3a; --muted:#6f5b66; --shadow:rgba(0,0,0,.15);
      --grad: linear-gradient(135deg,#ffe6ef 0%, #f3fbff 50%, #f2fff7 100%);
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:Inter,system-ui,"Noto Sans Thai",sans-serif;color:var(--text);background:#fff7fb}
    .hidden{display:none!important}
    .center{display:flex;align-items:center;justify-content:center}
    .btn{cursor:pointer;padding:.9rem 1.2rem;border:none;border-radius:999px;background:var(--pink);color:#fff;font-weight:700;box-shadow:0 10px 24px var(--shadow);transition:.2s}
    .btn:hover:not([disabled]){transform:translateY(-2px)}
    .btn[disabled]{opacity:.6; cursor:not-allowed}
    .btn.secondary{background:#fff;color:var(--pink);border:2px solid var(--pink)}
    .tiny{font-size:.85rem;color:var(--muted)}
    .pill{border-radius:999px;border:1px solid #ffd6e6;background:#fff;padding:6px 10px;font-size:.85rem;cursor:pointer}
    .pill.danger{border-color:#fecaca;color:#b91c1c}

    /* Gate */
    #gate{min-height:100dvh;background:var(--grad);padding:20px}
    #gateCard{max-width:720px;margin:auto;background:#fff;border-radius:22px;box-shadow:0 16px 48px var(--shadow);padding:28px 24px;text-align:center}
    #noMsg{margin-top:12px; padding:10px 12px; border:2px dashed #ffc2d4; border-radius:12px; background:#fff7fb; display:none}

    /* App */
    #app{position:relative;min-height:100dvh;background:var(--grad);overflow:hidden}
    .heart-stream{position:absolute;inset:0;pointer-events:none}
    .heart{position:absolute;top:-10vh;font-size:clamp(14px,2.2vw,28px);opacity:.85;animation:fall linear forwards}
    @keyframes fall{to{transform:translateY(115vh) rotate(360deg);opacity:.95}}

    /* Albums */
    #albums{max-width:1100px;margin:80px auto;padding:16px}
    .grid{display:grid;gap:14px;grid-template-columns:repeat(1,1fr)}
    @media(min-width:520px){.grid{grid-template-columns:repeat(2,1fr)}}
    @media(min-width:900px){.grid{grid-template-columns:repeat(3,1fr)}}
    .card{background:#fff;border:1px solid #ffe0ea;border-radius:16px;box-shadow:0 14px 36px var(--shadow);overflow:hidden;cursor:pointer}
    .thumb{height:200px;background:linear-gradient(135deg,#ffdbe8,#e8fff7);position:relative}
    .thumb img{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;object-position:center}
    .meta{display:flex;justify-content:space-between;align-items:center;padding:12px 14px}
    .badge{background:#ffe6ef;color:#c71d62;border-radius:999px;padding:6px 10px;font-size:.85rem;font-weight:700}

    /* Book */
    #bookWrap{max-width:980px;margin:30px auto 100px;padding:16px}
    .book{position:relative;perspective:1600px;height:clamp(380px,60vw,560px)}
    .page{position:absolute;inset:0;background:#fff;border-radius:16px;box-shadow:0 22px 55px var(--shadow);display:grid;grid-template-rows:auto 1fr auto;transform-origin:left center;transition:transform .8s cubic-bezier(.22,.61,.36,1)}
    .page.flipped{transform:rotateY(-180deg)}
    .header{padding:12px 16px;background:linear-gradient(180deg,#fff,#fff7fb);display:flex;justify-content:space-between;align-items:center;gap:8px}
    .header .row{display:flex;gap:8px;align-items:center}
    .body{padding:16px;display:grid;gap:10px}
    .photo{
      background:#f6f9fc;border:2px dashed #e5e9f2;border-radius:12px;
      display:grid;place-items:center;position:relative;overflow:hidden;
      aspect-ratio:16/9; /* ‡πÉ‡∏´‡πâ‡πÄ‡∏™‡∏ñ‡∏µ‡∏¢‡∏£‡∏ó‡∏∏‡∏Å‡∏à‡∏≠ */
    }
    .photo img{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;object-position:center}
    .editable{outline:2px dashed #ffc2d4; outline-offset:4px; border-radius:10px; padding:6px 8px}
    .editable:focus{background:#fff7fb}
    .metaLine{display:flex;gap:8px;flex-wrap:wrap;color:#6f5b66}
    .metaLine span{background:#fdf2f8;border-radius:999px;padding:6px 10px}
    .note{color:#6f5b66}
    .controls{display:flex;justify-content:space-between;align-items:center;margin-top:12px;gap:8px;flex-wrap:wrap}

    /* Popup */
    #infoBackdrop{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.35);backdrop-filter:blur(2px);z-index:70}
    #infoBackdrop.active{display:flex}
    #infoBox{background:#fff;border-radius:18px;max-width:480px;width:calc(100% - 40px);padding:20px 18px;box-shadow:0 20px 60px var(--shadow);text-align:center}
    #dlgBtns{display:flex;gap:8px;justify-content:center;flex-wrap:wrap}
  </style>
</head>
<body>
  <!-- Gate: Love question -->
  <section id="gate" class="center">
    <div id="gateCard">
      <h1 style="margin:0 0 8px">‡πÄ‡∏ò‡∏≠‡∏£‡∏±‡∏Å‡πÄ‡∏£‡∏≤‡πÑ‡∏´‡∏° üíï</h1>
      <div style="display:flex;gap:10px;justify-content:center;margin-top:8px">
        <button id="btnYes" class="btn">Yes</button>
        <button id="btnNo" class="btn secondary">No</button>
      </div>
      <div id="noMsg" class="tiny"></div>
    </div>
  </section>

  <!-- App -->
  <main id="app" class="hidden">
    <div class="heart-stream" id="heartStream"></div>

    <!-- Albums -->
    <section id="albums" class="hidden">
      <div style="max-width:1100px;margin:auto;padding:0 16px">
        <h2 style="margin:20px 0 10px">‡∏≠‡∏±‡∏•‡∏ö‡∏±‡πâ‡∏°‡∏Ñ‡∏£‡∏ö‡∏£‡∏≠‡∏ö‡∏Ç‡∏≠‡∏á‡πÄ‡∏£‡∏≤</h2>
        <div class="tiny">‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏à‡∏∞‡∏Ç‡∏∂‡πâ‡∏ô‡∏õ‡πä‡∏≠‡∏õ‡∏≠‡∏±‡∏õ‡∏ö‡∏≠‡∏Å‡∏ß‡πà‡∏≤ ‚Äú‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ñ‡∏∂‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏Ç‡∏≠‡∏á‡∏Å‡πâ‡∏≤‡∏ß‡∏ï‡πà‡∏≠‡πÑ‡∏õ‚Äù ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏õ‡∏∏‡πà‡∏° ‚Äú‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å‚Äù</div>
        <div class="grid" id="albumGrid" style="margin-top:14px"></div>
      </div>
    </section>

    <!-- Book -->
    <section id="bookWrap" class="hidden">
      <div style="max-width:980px;margin:auto;padding:0 16px">
        <div style="display:flex;justify-content:space-between;align-items:center;margin:10px 0;gap:8px;flex-wrap:wrap">
          <div class="badge" id="albumTitle">‡∏≠‡∏±‡∏•‡∏ö‡∏±‡πâ‡∏°</div>
          <div style="display:flex;gap:8px;flex-wrap:wrap">
            <button id="btnAddPhoto" class="btn">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏π‡∏õ</button>
            <button id="backToAlbums" class="btn secondary">‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏°‡∏ô‡∏π‡∏≠‡∏±‡∏•‡∏ö‡∏±‡πâ‡∏°</button>
          </div>
        </div>
        <div class="book" id="book"></div>
        <div class="controls">
          <button id="prev" class="btn secondary">‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</button>
          <button id="next" class="btn">‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</button>
          <span class="tiny" id="pageCounter"></span>
        </div>
        <p class="tiny" style="margin-top:8px">
          ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏π‡∏õ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î ‚Ä¢ ‡∏™‡πà‡∏ß‡∏ô <strong>üìç‡∏ó‡∏µ‡πà‡∏Ç‡∏≠‡∏á‡πÄ‡∏£‡∏≤ / üïí‡πÄ‡∏ß‡∏•‡∏≤ / ‡∏Ñ‡∏≥‡∏ö‡∏£‡∏£‡∏¢‡∏≤‡∏¢</strong> <em>‡πÅ‡∏Å‡πâ‡πÑ‡∏î‡πâ</em> (‡∏°‡∏µ‡∏Å‡∏£‡∏≠‡∏ö‡πÄ‡∏™‡πâ‡∏ô‡∏õ‡∏∞‡∏ä‡πà‡∏ß‡∏¢‡∏ö‡∏≠‡∏Å) ‚Ä¢ ‡∏•‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å‡∏õ‡∏∏‡πà‡∏°‡∏ñ‡∏±‡∏á‡∏Ç‡∏¢‡∏∞
        </p>
      </div>
    </section>

    <!-- Popup -->
    <div id="infoBackdrop" role="dialog" aria-modal="true" aria-labelledby="infoText">
      <div id="infoBox">
        <div id="infoText" style="margin-bottom:12px">‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°</div>
        <div id="dlgBtns">
          <button class="btn secondary hidden" id="dlgNo">‡πÑ‡∏°‡πà</button>
          <button class="btn" id="dlgYes">‡∏ï‡∏Å‡∏•‡∏á</button>
          <button class="btn secondary hidden" id="dlgAlt">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</button>
        </div>
      </div>
    </div>
  </main>

  <script>
  "use strict";

  /* ---------- Data ---------- */
  const MAX_PAGES_PER_ALBUM = 15;
  const DEFAULT_DATA={ albums:[
    {month:1, title:'‡∏Ñ‡∏£‡∏ö‡∏£‡∏≠‡∏ö 1 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô', pages:[
      {title:'‡∏´‡∏ô‡πâ‡∏≤ 1', place:'‡∏ó‡∏µ‡πà‡∏Ç‡∏≠‡∏á‡πÄ‡∏£‡∏≤', time:'‡∏ß‡∏±‡∏ô‡πÅ‡∏£‡∏Å', note:'‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏Ç‡∏≠‡∏á‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏£‡∏≤‡∏ß', img:''},
      {title:'‡∏´‡∏ô‡πâ‡∏≤ 2', place:'', time:'', note:'‡πÄ‡∏ï‡∏¥‡∏°‡∏†‡∏≤‡∏û‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏£‡∏á‡∏à‡∏≥', img:''}
    ]},
    {month:2, title:'‡∏Ñ‡∏£‡∏ö‡∏£‡∏≠‡∏ö 2 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô', pages:[]},
    {month:3, title:'‡∏Ñ‡∏£‡∏ö‡∏£‡∏≠‡∏ö 3 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô', pages:[]},
  ]};
  let DATA = load();
  function load(){ try{const t=localStorage.getItem('albumsDataSimple'); if(t) return JSON.parse(t);}catch(e){} return DEFAULT_DATA; }
  function save(){ localStorage.setItem('albumsDataSimple', JSON.stringify(DATA)); }

  /* ---------- Gate (Yes/No) ---------- */
  const gate = document.getElementById('gate');
  const app  = document.getElementById('app');
  const btnYes = document.getElementById('btnYes');
  const btnNo  = document.getElementById('btnNo');
  const noMsg  = document.getElementById('noMsg');

  btnYes.addEventListener('click', ()=>{
    // ‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏≠‡∏±‡∏•‡∏ö‡∏±‡πâ‡∏°‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
    gate.classList.add('hidden');
    app.classList.remove('hidden');
    showAlbums();
  });

  btnNo.addEventListener('click', ()=>{
    // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° + ‡∏ô‡∏±‡∏ö‡∏ñ‡∏≠‡∏¢‡∏´‡∏•‡∏±‡∏á 5 ‡∏ß‡∏¥ ‡πÅ‡∏•‡∏∞ disable ‡∏õ‡∏∏‡πà‡∏°
    let left = 5;
    btnYes.disabled = btnNo.disabled = true;
    noMsg.style.display = 'block';
    noMsg.innerHTML = `‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏¥‡πÉ‡∏´‡πâ‡πÑ‡∏°‡πà‡∏£‡∏±‡∏Å ‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏±‡∏Å‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô ‡∏ä‡∏¥!! üòùü§™ <br/>‡∏õ‡∏¥‡∏î‡πÉ‡∏ô <strong id="count">5</strong> ‡∏ß‡∏¥`;
    const c = document.getElementById('count');
    const t = setInterval(()=>{
      left--; c.textContent = String(left);
      if(left<=0){
        clearInterval(t);
        noMsg.style.display = 'none';
        btnYes.disabled = btnNo.disabled = false;
      }
    },1000);
  });

  /* ---------- Hearts BG ---------- */
  const heartStream=document.getElementById('heartStream');
  const hearts=['üíó','üíñ','üíì','üíû','üíù','üíò','üíü'];
  setInterval(()=>{
    const h=document.createElement('div');
    h.className='heart';
    h.textContent=hearts[Math.floor(Math.random()*hearts.length)];
    h.style.left=(Math.random()*100)+'%';
    h.style.animationDuration=(6+Math.random()*6)+'s';
    heartStream.appendChild(h);
    setTimeout(()=>h.remove(), 13000);
  }, 400);

  /* ---------- Popup helpers ---------- */
  const infoBackdrop=document.getElementById('infoBackdrop');
  const infoText=document.getElementById('infoText');
  const dlgYes=document.getElementById('dlgYes');
  const dlgNo=document.getElementById('dlgNo');
  const dlgAlt=document.getElementById('dlgAlt');

  function infoPopup(msg,{okText='‡∏ï‡∏Å‡∏•‡∏á'}={}){ // info only
    infoText.textContent=msg;
    dlgNo.classList.add('hidden');
    dlgAlt.classList.add('hidden');
    dlgYes.textContent=okText;
    infoBackdrop.classList.add('active');
    const close=()=>{ infoBackdrop.classList.remove('active'); dlgYes.onclick=null; };
    dlgYes.onclick=close;
  }
  function confirmPopup(msg,{yesText='‡πÉ‡∏ä‡πà',noText='‡πÑ‡∏°‡πà'}={},onYes){ // yes/no
    infoText.textContent=msg;
    dlgNo.classList.remove('hidden');
    dlgAlt.classList.add('hidden');
    dlgYes.textContent=yesText;
    dlgNo.textContent=noText;
    infoBackdrop.classList.add('active');
    const close=()=>{ infoBackdrop.classList.remove('active'); dlgYes.onclick=null; dlgNo.onclick=null; };
    dlgNo.onclick=close;
    dlgYes.onclick=()=>{ close(); onYes && onYes(); };
  }
  function infoWithAlt(msg,{altText='‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å', onAlt}={}){ // info + alt button
    infoText.textContent=msg;
    dlgNo.classList.add('hidden');
    dlgYes.textContent='‡∏ï‡∏Å‡∏•‡∏á';
    dlgAlt.classList.remove('hidden');
    dlgAlt.textContent=altText;
    infoBackdrop.classList.add('active');
    const close=()=>{ infoBackdrop.classList.remove('active'); dlgYes.onclick=null; dlgAlt.onclick=null; };
    dlgYes.onclick=close;
    dlgAlt.onclick=()=>{ onAlt && onAlt(); close(); };
  }

  /* ---------- Albums Grid ---------- */
  const albumGrid=document.getElementById('albumGrid');
  function showAlbums(){
    document.getElementById('albums').classList.remove('hidden');
    document.getElementById('bookWrap').classList.add('hidden');
    renderAlbumGrid();
  }

  function renderAlbumGrid(){
    albumGrid.innerHTML='';
    DATA.albums.sort((a,b)=>a.month-b.month).forEach(alb=>{
      const hasPages = alb.pages && alb.pages.length>0;
      const cover = (alb.pages||[]).find(p=>p.img);
      const card=document.createElement('div'); card.className='card';
      card.innerHTML = `
        <div class="thumb">${cover?`<img src="${cover.img}">`:''}</div>
        <div class="meta">
          <div>
            <strong>${alb.title||('‡∏Ñ‡∏£‡∏ö‡∏£‡∏≠‡∏ö '+alb.month+' ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô')}</strong>
            <div class="tiny">${hasPages? (alb.pages.length+' ‡∏´‡∏ô‡πâ‡∏≤'):'‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ñ‡∏∂‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏Ç‡∏≠‡∏á‡∏Å‡πâ‡∏≤‡∏ß‡∏ï‡πà‡∏≠‡πÑ‡∏õ ‚ú®'}</div>
          </div>
          <span class="badge">M${alb.month}</span>
        </div>`;
      card.addEventListener('click',()=>{
        if(!hasPages){
          infoWithAlt('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ñ‡∏∂‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏Ç‡∏≠‡∏á‡∏Å‡πâ‡∏≤‡∏ß‡∏ï‡πà‡∏≠‡πÑ‡∏õ ‚ú®', {
            altText:'‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å',
            onAlt:()=> addFirstPage(alb.month)
          });
          return;
        }
        openAlbum(alb.month);
      });
      albumGrid.appendChild(card);
    });

    // add new album card
    const add=document.createElement('div'); add.className='card';
    add.innerHTML=`<div class="thumb"></div><div class="meta"><strong>+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏≠‡∏±‡∏•‡∏ö‡∏±‡πâ‡∏°‡πÉ‡∏´‡∏°‡πà</strong><span class="badge">NEW</span></div>`;
    add.addEventListener('click',()=>{
      const m = prompt('‡πÉ‡∏™‡πà‡πÄ‡∏•‡∏Ç‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Ñ‡∏£‡∏ö‡∏£‡∏≠‡∏ö (‡πÄ‡∏ä‡πà‡∏ô 4 = ‡∏Ñ‡∏£‡∏ö‡∏£‡∏≠‡∏ö 4 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô)');
      const month = parseInt(m||'0',10); if(!month) return;
      if(DATA.albums.find(a=>a.month===month)){ infoPopup('‡∏°‡∏µ‡∏≠‡∏±‡∏•‡∏ö‡∏±‡πâ‡∏°‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß'); return; }
      DATA.albums.push({month, title:`‡∏Ñ‡∏£‡∏ö‡∏£‡∏≠‡∏ö ${month} ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô`, pages:[]}); save(); renderAlbumGrid();
    });
    albumGrid.appendChild(add);
  }

  function addFirstPage(month){
    const alb = DATA.albums.find(a=>a.month===month);
    if(!alb) return;
    if(!alb.pages) alb.pages=[];
    alb.pages.push({title:'‡∏´‡∏ô‡πâ‡∏≤ 1', place:'', time:'', note:'‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏£‡∏á‡∏à‡∏≥‡∏Ç‡∏≠‡∏á‡πÄ‡∏£‡∏≤', img:''});
    save();
    openAlbum(month);
  }

  /* ---------- Book Viewer ---------- */
  let CURRENT_ALBUM=null, currentPage=0;

  function openAlbum(month){
    CURRENT_ALBUM = DATA.albums.find(a=>a.month===month);
    if(!CURRENT_ALBUM) return;
    document.getElementById('albums').classList.add('hidden');
    document.getElementById('bookWrap').classList.remove('hidden');
    document.getElementById('albumTitle').textContent = CURRENT_ALBUM.title || ('‡∏Ñ‡∏£‡∏ö‡∏£‡∏≠‡∏ö '+CURRENT_ALBUM.month+' ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô');
    currentPage=0;
    renderPages();
    updateFlip();
  }

  function pageTpl(i,p,isLast){
    return `<article class="page ${i<currentPage?'flipped':''}" data-i="${i}" style="z-index:${100-i}">
      <div class="header">
        <div class="row">
          <strong class="editable" contenteditable="true" oninput="editTitle(${i},this.innerText)">${p.title||('‡∏´‡∏ô‡πâ‡∏≤ '+(i+1))}</strong>
          <span class="badge">${isLast?'THE END':'PAGE '+(i+1)}</span>
        </div>
        <div class="row">
          <button class="pill danger" onclick="deletePage(${i})">üóëÔ∏è ‡∏•‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ</button>
        </div>
      </div>
      <div class="body">
        <div class="photo" onclick="triggerUpload(${i})">
          ${p.img?`<img src="${p.img}">`:`<span class="tiny">‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ</span>`}
        </div>
        <div class="metaLine">
          <span>üìç <em class="editable" contenteditable="true" oninput="editPlace(${i},this.innerText)">${p.place||''}</em></span>
          <span>üïí <em class="editable" contenteditable="true" oninput="editTime(${i},this.innerText)">${p.time||''}</em></span>
        </div>
        <div class="note editable" contenteditable="true" oninput="editNote(${i},this.innerText)">${p.note||''}</div>
      </div>
    </article>`;
  }

  function renderPages(){
    const book=document.getElementById('book');
    const pages = CURRENT_ALBUM.pages;
    const last=pages.length-1;
    book.innerHTML = pages.map((p,i)=>pageTpl(i,p, i===last)).join('') + `<input id="uploader" type="file" accept="image/*" class="hidden"/>`;
    document.getElementById('uploader').addEventListener('change', handleUpload);
    document.getElementById('pageCounter').textContent = `(${pages.length}/${MAX_PAGES_PER_ALBUM})`;
    document.getElementById('btnAddPhoto').disabled = pages.length>=MAX_PAGES_PER_ALBUM;

    if(!pages.length){
      infoWithAlt('‡∏≠‡∏±‡∏•‡∏ö‡∏±‡πâ‡∏°‡∏ô‡∏µ‡πâ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ ‡∏•‡∏≠‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏π‡∏õ‡πÅ‡∏£‡∏Å‡∏Å‡∏±‡∏ô‡πÄ‡∏•‡∏¢?', {
        altText:'‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å',
        onAlt:()=>{ CURRENT_ALBUM.pages.push({title:'‡∏´‡∏ô‡πâ‡∏≤ 1', place:'', time:'', note:'', img:''}); save(); renderPages(); updateFlip(); }
      });
    }
  }

  function updateFlip(){
    const pages=[...document.querySelectorAll('#book .page')];
    pages.forEach((pg,i)=>{ pg.classList.toggle('flipped', i<currentPage); });
    document.getElementById('prev').disabled = currentPage===0;
    document.getElementById('next').textContent = currentPage===pages.length-1? '‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏°‡∏ô‡∏π‡∏≠‡∏±‡∏•‡∏ö‡∏±‡πâ‡∏°' : '‡∏ñ‡∏±‡∏î‡πÑ‡∏õ';
  }

  document.getElementById('next').addEventListener('click',()=>{
    const total=(CURRENT_ALBUM?.pages||[]).length;
    if(currentPage<total-1){ currentPage++; updateFlip(); }
    else { showAlbums(); }
  });
  document.getElementById('prev').addEventListener('click',()=>{ if(currentPage>0){ currentPage--; updateFlip(); }});
  document.getElementById('backToAlbums').addEventListener('click', showAlbums);

  document.getElementById('btnAddPhoto').addEventListener('click',()=>{
    const pages=CURRENT_ALBUM.pages;
    if(pages.length>=MAX_PAGES_PER_ALBUM){ infoPopup(`‡∏Ñ‡∏£‡∏ö ${MAX_PAGES_PER_ALBUM} ‡∏£‡∏π‡∏õ‡πÅ‡∏•‡πâ‡∏ß`); return; }
    pages.push({title:`‡∏´‡∏ô‡πâ‡∏≤ ${pages.length+1}`, place:'', time:'', note:'', img:''});
    save(); renderPages(); updateFlip();
  });

  // inline editors save
  window.editTitle=(i,val)=>{ CURRENT_ALBUM.pages[i].title=val; persist(); };
  window.editPlace=(i,val)=>{ CURRENT_ALBUM.pages[i].place=val; persist(); };
  window.editTime =(i,val)=>{ CURRENT_ALBUM.pages[i].time =val; persist(); };
  window.editNote =(i,val)=>{ CURRENT_ALBUM.pages[i].note =val; persist(); };

  // delete page (Yes/No)
  window.deletePage=(i)=>{
    confirmPopup('‡∏•‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡πÅ‡∏ô‡πà‡∏ô‡∏∞?', {yesText:'‡πÉ‡∏ä‡πà', noText:'‡πÑ‡∏°‡πà'}, ()=>{
      CURRENT_ALBUM.pages.splice(i,1);
      if(currentPage>0) currentPage--;
      persist(); renderPages(); updateFlip();
    });
  };

  // upload
  let uploadIndex=0;
  window.triggerUpload=(i)=>{ uploadIndex=i; document.getElementById('uploader').click(); };
  function handleUpload(e){
    const f=e.target.files[0]; if(!f) return;
    const r=new FileReader();
    r.onload=()=>{ CURRENT_ALBUM.pages[uploadIndex].img=r.result; persist(); renderPages(); updateFlip(); };
    r.readAsDataURL(f);
  }
  function persist(){ save(); }

  // self-tests (console)
  (function(){
    try{
      console.group('%cSelf-Tests','color:#c2185b;font-weight:bold');
      console.assert(document.getElementById('btnYes') && document.getElementById('btnNo'), 'Love Gate buttons present');
      console.assert(typeof showAlbums === 'function', 'showAlbums exists');
      console.assert(typeof renderPages === 'function', 'renderPages exists');
      console.log('All basic tests passed ‚úì');
      console.groupEnd();
    }catch(e){ console.error('Self-tests failed', e); }
  })();
  </script>
</body>
</html>
